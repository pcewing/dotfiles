#!/bin/sh

# This script may be invoked when starting an X11 session via a display manager
# or otherwise. For more information, see:
# https://wiki.debian.org/Xsession
#
# To run shellcheck properly on this file:
# $ cd ~/dot/config
# $ shellcheck --shell=dash -x ./env ./xsession

DOTFILES_LOG_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/dotfiles/logs"
XSESSION_LOG_FILE="xsession_$(date +"%Y%m%d_%H%M%S").log"
XSESSION_LOG_PATH="${DOTFILES_LOG_DIR}/${XSESSION_LOG_FILE}"

log() {
    echo "$*" >> "$XSESSION_LOG_PATH"
}

# Initialize log directory and clean up old logs
mkdir -p "$DOTFILES_LOG_DIR"
if [ -x "$HOME/dot/bin/cleanup_logs.sh" ]; then
    "$HOME/dot/bin/cleanup_logs.sh"
else
    log "Warning: $HOME/dot/bin/cleanup_logs.sh not found or not executable"
fi

# Log PATH both before and after we source the env file so we can debug issues
# if it's not modifying it correctly
log "Starting at $(date)"
log "PATH: $PATH"

# Add user-defined fonts (only if directory exists)
if [ -d "$HOME/.fonts" ]; then
    xset +fp "$HOME/.fonts"
    xset fp rehash
fi

# Disable bell
xset -b

# Enable zapping (C-A-<Bksp> kills X)
setxkbmap -option terminate:ctrl_alt_bksp

# Enforce correct locales from the beginning
unset LC_COLLATE
export LC_CTYPE=en_US.UTF-8
export LC_TIME=en_US.UTF-8
export LC_NUMERIC=en_US.UTF-8
export LC_MONETARY=en_US.UTF-8
export LC_MESSAGES=C
export LC_PAPER=en_US.UTF-8
export LC_NAME=en_US.UTF-8
export LC_ADDRESS=en_US.UTF-8
export LC_TELEPHONE=en_US.UTF-8
export LC_MEASUREMENT=en_US.UTF-8
export LC_IDENTIFICATION=en_US.UTF-8

# Use XToolkit in java applications
export AWT_TOOLKIT=XToolkit

# Set background color
xsetroot -solid "#333333"

# Set maximum core dump file size to unlimited
# Note that shellcheck will warn that `ulimit -c` is not supported in POSIX sh;
# however, dash is the standard implementation of sh on Linux and it does
# support this. See comments at the top of file for properly running shellcheck
# on this script.
ulimit -c unlimited

# Set up environment variables
# shellcheck source=./env
ENV_CONFIG_PATH="$HOME/dot/config/env"
if [ -f "$ENV_CONFIG_PATH" ]; then
    . "$ENV_CONFIG_PATH"
    log "Sourced ${ENV_CONFIG_PATH} configuration file"
    log "PATH: $PATH"
else
    log "ERROR: ${ENV_CONFIG_PATH} not found"
fi

# Wrap exec in a function so we can redirect its output cleanly
exec_i3() {
    exec i3 -V -d all
}

# Start i3 and log output
log "Checking for i3: $(command -v i3 2>&1)"

# Try to start i3 and log any errors
if command -v i3 >/dev/null 2>&1; then
    log "Found i3 at: $(command -v i3)"
    log "DISPLAY is: $DISPLAY"
    exec_i3 >> "$XSESSION_LOG_PATH" 2>&1
else
    log "ERROR: i3 not found in PATH"
    log "PATH was: $PATH"
    # Try to show a notification
    notify-send "X Session Failed" "i3 not found in PATH" 2>/dev/null || true
    exit 1
fi
